@model RightsU_Entities.Event_Template

@{
    MessageKey objMessageKey = new MessageKey();
    if (Session["objMessageKey"] != null)
    {
        objMessageKey = (MessageKey)Session["objMessageKey"];
    }

    var Subject = ViewBag.Subject;

    int Event_Template_Code = 0;
    string AddChecked = "checked=\"checked\"";
    string ExistChecked = "";
    if (Model != null)
    {
        Event_Template_Code = Model.Event_Template_Code;
        ExistChecked = "checked=\"checked\"";
        AddChecked = "";
    }

    string TableTypeBody = "checked=\"checked\"";
    string TableTypeAttachment = "";
    if (Model != null)
    {
        if(Model.Table_Type == "A")
        {
            TableTypeAttachment = "checked=\"checked\"";
            TableTypeBody = "";
        }
    }
}

<script>
    var URL_Bind_Template = '@Url.Action("Bind_Template_Data", "Event_Config_Template")';
    var SelectedValue = "@ViewBag.lst_EventTemplate.SelectedValue";

    $(document).ready(function () {
        debugger;
        if ('@objMessageKey.LayoutDirection' == "RTL") {
            $('.lblExchangeRate').css("padding-right", "2%");
        }
        else {
            $('.lblExchangeRate').css("padding-left", "2%");
        }

        $('.configTemplate').on("change", function () {
            debugger;
            
            if ($(".configTemplate:checked").val() == "AddNew") {
                $('#divInputField').empty();
                var input = $('<input>').attr({
                    type: 'text',
                    id: 'TemplateName',
                    name: 'TemplateName',
                    autocomplete: 'off'
                });
                input.css('width', '80%');
                $('#divInputField').html(input);
            }
            else
            {
                $('#divInputField').empty();
                var select = $('<select>').attr({
                    id: 'ExistingTemplate',
                    name: 'ExistingTemplate',
                    onchange: 'BindEditorDataOnChange()'
                }).addClass('form_input chosen-select');

                var options = @Html.Raw(Json.Encode(ViewBag.lst_EventTemplate));
                
                select.append($('<option>').attr('value', '0').text('Please Select'));
                if (options && options.length > 0) {                   
                    options.forEach(function (option) {
                        //select.append($('<option>').attr('value', option.Value).text(option.Text));
                        var $option = $('<option>').attr('value', option.Value).text(option.Text);
                        
                        if (option.Value == SelectedValue) {
                            $option.prop('selected', true);
                        }
                        select.append($option);
                    });
                }

                $('#divInputField').append(select);
                initializeChosen();
                $('#ExistingtTemplate_chosen').prop('style', 'width:80% !important');
                BindEditorDataOnChange();
            }
        });
        $('.configTemplate').trigger("change");

        CKEDITOR.replace('texteditor');
    });

    document.getElementById("searchInput").addEventListener("input", function () {
        debugger;
        var filter, ul, li, txtValue;
        filter = this.value.toUpperCase();
        ul = document.getElementById("itemList");
        li = ul.getElementsByTagName("li");
        for (var i = 0; i < li.length; i++) {
            txtValue = li[i].textContent || li[i].innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
    });

    function BindEditorDataOnChange() {
        debugger;
        var ExistingValue = $('#ExistingTemplate').val();

        if (ExistingValue == 0) {
            CKEDITOR.instances.texteditor.setData();
            $('#Subject').val('');
            return false;
        }

        $.ajax({
            type: "POST",
            url: URL_Bind_Template,
            traditional: true,
            enctype: 'multipart/form-data',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({
                ExistingValue: ExistingValue
            }),
            success: function (result) {
                debugger;
                CKEDITOR.instances.texteditor.setData(result.Template);

                $("#Subject").val(result.Subject);

            }
        })
    }
    
</script>

<script>
    function allowDrop(ev) {
        ev.preventDefault(); // Allow dropping
    }

    function drag(ev, text) {
        ev.dataTransfer.setData("text", text); // Set the data to be transferred
    }

    function drop(ev) {
        ev.preventDefault(); // Prevent the default action

        var text = ev.dataTransfer.getData("text"); // Get the text data

        var textarea = document.getElementById('cke_1_contents');
        textarea.focus(); // Focus on the textarea

        // Get the current cursor position
        var cursorPos = textarea.selectionStart;

        // Insert the text at the cursor position
        var newText = textarea.value.substring(0, cursorPos) + text + textarea.value.substring(cursorPos);
        textarea.value = newText;

        // Move the cursor position to the end of the inserted text
        textarea.selectionStart = cursorPos + text.length;
        textarea.selectionEnd = cursorPos + text.length;
    }
</script>

<div class="modal_block modal_header">
    <a class="close" onclick="ClosePopup()">
        <span>X</span>
        <span class="sr-only">Close</span>
    </a>
    <h4>@ViewBag.Email_Type - @ViewBag.Platform (@ViewBag.Template_Type) - Template</h4>
</div>
<div class="grid_area" style="margin: 0 auto; width: 98%;">
    <div class="paging_area clearfix" style="height:50px !important;">
        <div class="col-md-3" style="margin-top: 14px;">
            <input type="radio" name="configTemplate" class="configTemplate" id="rbAdd" value="AddNew" @AddChecked /><text>&nbsp;&nbsp; <b>Add New</b> &nbsp;&nbsp;</text>
            <input type="radio" name="configTemplate" class="configTemplate" id="rbExist" value="Exists" @ExistChecked /><text>&nbsp;&nbsp; <b>Use Existing</b> &nbsp;&nbsp;</text>
        </div>
        <div class="col-md-4" id="divInputField" style="margin-top: 1%;">

        </div>
        @if (Convert.ToString(ViewBag.Platform) == "Email")
        {
            <div class="col-md-4" style="margin-top: 14px; ">
                <input type="radio" name="dataAttachment" class="configTemplate" id="rbDataAsBody" value="B" @TableTypeBody /><text>&nbsp;&nbsp; <b>Data As Body</b> &nbsp;&nbsp;</text>
                <input type="radio" name="dataAttachment" class="configTemplate" id="rbDataAsAttachment" value="A" @TableTypeAttachment /><text>&nbsp;&nbsp; <b>Data As Attachment</b> &nbsp;&nbsp;</text>
            </div>
        }
    </div>    
    <div class="paging_area clearfix" style="height:50px !important;">
        <div class="col-md-12" style="margin-top: 12px;">
            <span class="pull-left">Subject : </span>&nbsp;&nbsp;&nbsp;&nbsp;
            <input autocomplete="off" type="text" name="Subject" id="Subject" value="@Subject" style="width:83%" placeholder="Add a subject" />
        </div>
    </div>
    <div class="tab-content clearfix table-wrapper scale_table_container">
        <div class="scale_table_block col-md-9" id="divRichTextArea" style="height: 315px !important; overflow-y:scroll;">
            <textarea id="texteditor" name="texteditor"></textarea>
        </div>
        <div class="scale_table_block col-md-3">
            <div><input type="text" class="form_input" id="searchInput" placeholder="Search..." style="width: 100%;"></div>
            <div id="divPlaceholder" style="height: 270px !important; overflow-y: scroll; margin-top: 10px;">
                <ul id="itemList">
                    @foreach (var item in ViewBag.lst_EventTemplateKeys)
                    {
                        <li draggable="true" ondragstart="drag(event, '@item.Text')"> @item.Text </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="modal_block_full" style="margin-top: 10px;">
    <div class="form_links">
        <ul class="modal_block clearfix" style="padding-left:10px; padding-top: 10px;">
            <li>
                <input type="button" class="btn btn-primary" value="@objMessageKey.Save" onclick="Save_Event_Template('@ViewBag.Email_Config_Template_Code', '@ViewBag.Template_Type', '@ViewBag.Platform_Code')" />
                <input type="button" class="btn btn-primary" value="@objMessageKey.Cancel" onclick="ClosePopup()" />
            </li>
        </ul>
    </div>
</div>

