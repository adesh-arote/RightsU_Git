@model List<RightsU_Entities.Syn_Deal_Material>
@using UTOFrameWork.FrameworkClasses
@{
    /**/

    RightsU_Entities.Deal_Schema objSchema = new RightsU_Entities.Deal_Schema();
    if (Session[RightsU_Entities.RightsU_Session.Syn_DEAL_SCHEMA] != null)
    {
        objSchema = (RightsU_Entities.Deal_Schema)Session[RightsU_Entities.RightsU_Session.Syn_DEAL_SCHEMA];
    }
    MessageKey objMessageKey = new MessageKey();
    if (Session["objMessageKey"] != null)
    {
        objMessageKey = (MessageKey)Session["objMessageKey"];
    }
}
<script type="text/javascript">
    var PaymentIntCode = 0;
    var IsAddEditMode = "N";
    var MessageFrom = '';
    $(document).ready(function () {
       // $("#ancFileName").attr('href', 'Help/index.html?IntCode=Login');
        if ('@ViewBag.Record_Locking_Code' != '')
        {
            var fullUrl = '@Url.Action("Refresh_Lock", "Global", null, Request.Url.Scheme)'
            Call_RefreshRecordReleaseTime(@ViewBag.Record_Locking_Code,fullUrl);
        }

        if("@ViewBag.Message" !="")
        {
            if("@ViewBag.Mode"=="Error")
            {
                showAlert("E","@ViewBag.Message");
            }
            else
                showAlert("S","@ViewBag.Message");
        }

        if('@ViewBag.PageMode' !="V" && '@ViewBag.PageMode' !="APRV")
        {
            var txtRemark = document.getElementById('txtMaterialRemarks');
            countChar(txtRemark);
        }

        $("#Quantity").numeric({
            allowMinus   : false,
            allowThouSep : false,
            allowDecSep  : false
        });
        addNumeric();
        LoadSynDealMaterial(0,'Y');
        initializeTooltip();
    });
    function addNumeric() {
        $(".pagingSize").numeric({
            allowMinus: false,
            allowThouSep: false,
            allowDecSep: false,
            max: 99,
            min: 1
        });
    }
    function ValidatePageSize() {
        var recordPerPage = $('#txtPageSize').val()
        if ($.trim(recordPerPage) != '') {
            var pageSize = parseInt(recordPerPage);
            if (pageSize > 0)
                return true;
        }
        $('#txtPageSize').addClass("required");
        return false;
    }
    function PageSize_OnChange() {
        if (CheckEditMode()) {
            $('.required').removeClass('required');
            $("[required='required']").removeAttr("required");
            var IsValid = ValidatePageSize();
            if (IsValid) {
                LoadSynDealMaterial(0, 'Y');
            }
            else
                return false;
        }
    }
    function pageBinding() {
        LoadSynDealMaterial(0, 'Y');
    }
    /*Bind Syn Material Grid*/
    function LoadSynDealMaterial(pagenumber,isLoad) {
        showLoading();
        var txtPageSize = $("#txtPageSize").val();
        $.ajax({
            type: "POST",
            url: '@Url.Action("BindGridSynMaterial", "Syn_Material")',
            traditional: true,
            enctype: 'multipart/form-data',
            contentType: "application/json; charset=utf-8",
            dataType: "html",
            data: JSON.stringify({
                txtPageSize: txtPageSize,
                page_No: pagenumber
            }),
            success: function (result) {
                if (result == "true")
                {
                    redirectToLogin();
                }
                else {
                    $('#dvDealSynMaterialList').empty();
                    $('#dvDealSynMaterialList').html(result);
                    SetPaging(txtPageSize);
                    initializeTooltip();
                    hideLoading();
                }
            },
            error: function (result) {
                alert('Error: ' + result.responseText);
            }
        });
    }

    function CheckEditMode() {
        if(IsAddEditMode == 'Y'){
            message = '@objMessageKey.PleasecompletetheAddEditfirst';
            showAlert('E',message);
            return false;
        }
        else{
            return true;
        }
    }

    function OnBlur() {
        debugger
        if ($('#txtPageSize').val() == '' || $('#txtPageSize').val() == 0) {
            $('#txtPageSize').val() == 10;
        }
    }

    function RequiredFieldValidation()
    {
        var returnVal = true;
        var Title_Code = $("#Title_Code").val();
        var Material_Type_Code = $("#Material_Type_Code").val();
        var Material_Medium_Code = $("#Material_Medium_Code").val();
        var Quantity = $("#Quantity").val();

        if (Title_Code == "0") {
            $('#Title_Code').addClass('required');
            returnVal = false;
        }

        else if (Material_Type_Code == "0") {
            $('#Material_Type_Code').addClass('required');
            returnVal = false;
        }

        else if (Material_Medium_Code == "0") {
            $('#Material_Medium_Code').addClass('required');
            returnVal = false;
        }

        else if (Quantity == "") {
            $('#Quantity').addClass('required');
            returnVal = false;
        }

        if ( parseInt(Quantity) == 0) {
            showAlert('E','@objMessageKey.Quantitycannotbezero');
            //return false;
            $('#Quantity').addClass('required');
            returnVal = false;
        }
        return returnVal;
    }


    /*Save/Update Payment Terms */
    function SaveMaterial(Syn_Deal_Material_Code, Title_Code, Material_Type_Code, Material_Medium_Code, Quantity, Title_Codes, strAddTitle_Code)
    {
        var pageNo = $('#hdnpage_index').val();
        debugger;
        showLoading();
        $.ajax({
            type: "POST",
            url: '@Url.Action("SaveMaterial", "Syn_Material")',
            traditional: true,
            enctype: 'multipart/form-data',
            contentType: "application/json; charset=utf-8",
            dataType: "html",
            data: JSON.stringify({
                Syn_Deal_Material_Code: Syn_Deal_Material_Code,
                Title_Code: Title_Code,
                Material_Type_Code: Material_Type_Code,
                Material_Medium_Code: Material_Medium_Code,
                Quantity:Quantity,
                Title_Codes: Title_Codes,
                strAddTitle_Code: strAddTitle_Code
            }),
            success: function (result) {
                if (result == "true")
                {
                    redirectToLogin();
                }
                else{
                    hideLoading();
                    if(result == "N")
                    {
                        showAlert('E','@objMessageKey.CombinationconflictswithotherMaterialrecords');
                        return false;
                    }
                    else{
                        //$('#dvDealSynMaterialList').html(result);
                        var strMessage='@objMessageKey.Materialaddedsuccessfully';
                        if(Syn_Deal_Material_Code > 0)
                            strMessage='@objMessageKey.Materialupdatedsuccessfully';
                        showAlert('S', strMessage);
                        IsAddEditMode="N";
                        LoadSynDealMaterial(pageNo,'Y');
                        initializeTooltip();
                    }
                }
            },
            error: function (result) {
                alert('Error: ' + result.responseText);
            }
        });
    }

    function checkForsave(NewRow) {
        //alert(NewRow);
        debugger;
        $('.required').removeClass('required');
        var  returnVal =  RequiredFieldValidation();
        if(returnVal)
        {
            var Syn_Deal_Material_Code = 0
            if (NewRow == 1)
            {
                Syn_Deal_Material_Code = $("#Syn_Deal_Material_Code").val();
            }

            var strAddTitle_Code = '', Title_Codes = '';
            var Is_Acq_Syn_Material_MultiTitle = $("#hdnIsAcqSynMaterialMultiTitle").val();
            if (Is_Acq_Syn_Material_MultiTitle == "Y") {
                strAddTitle_Code = ($("#ddlTitle_Code").val()).join(',');
                //Title_Codes = ($("#ddlTitle_Code option:selected").text()).join(',');

                var items = [];
                $('#ddlTitle_Code option:selected').each(function () { items.push($(this).text()); });
                Title_Codes = items.join(',');
                var Title_Code = 0;
            }
            else {
                var Title_Codes = $("#Title_Code option:selected").text();
                var Title_Code = $("#Title_Code").val();
            }
           // var Title_Codes= $("#Title_Code option:selected").text();
            //var Syn_Deal_Material_Code = $("#Syn_Deal_Material_Code").val();
           // var Title_Code = $("#Title_Code").val();
            var Material_Type_Code = $("#Material_Type_Code").val();
            var Material_Medium_Code = $("#Material_Medium_Code").val();
            var Quantity = $("#Quantity").val();
            SaveMaterial(Syn_Deal_Material_Code, Title_Code, Material_Type_Code, Material_Medium_Code, Quantity, Title_Codes, strAddTitle_Code);
        }
    }


    function OnDeleteClick(Syn_Deal_Material_Code)
    {
        if(CheckEditMode())
        {
            $('#hdn_Command_Name').val('DELETE');
            PaymentIntCode = Syn_Deal_Material_Code;
            showAlert("I",'@objMessageKey.Areyousureyouwanttodeletethismaterial',"OKCANCEL");
        }
    }

    function handleOk() {
        if (MessageFrom == 'SV') {
            if ($('#hdnTabName').val() == '') {
                $('#hdn_Command_Name').val('');
                window.location.href = '@Url.Action("Index", "Syn_List")';
            }
        }
        if ($('#hdn_Command_Name').val() != undefined && $('#hdn_Command_Name').val() != '' && $('#hdn_Command_Name').val() == "CANCEL_SAVE_DEAL") {
            location.href = '@Url.Action("Cancel", "Syn_Material")';
        } else if ($('#hdn_Command_Name').val() != undefined && $('#hdn_Command_Name').val() != '' && $('#hdn_Command_Name').val() == "DELETE") {
            DeleteMaterial();
        }
        
    }

    function DeleteMaterial() {
        showLoading();
        var txtPageSize = $("#txtPageSize").val();
        var pageNo = $('#hdnpage_index').val();
        $.ajax({
            type: "POST",
            url: '@Url.Action("Delete", "Syn_Material")',
            traditional: true,
            enctype: 'multipart/form-data',
            contentType: "application/json; charset=utf-8",
            dataType: "html",
            data: JSON.stringify({
                Syn_Deal_Material_Code: PaymentIntCode,
                txtPageSize: txtPageSize,
                pageNo: pageNo
            }),
            success: function (result) {
                if (result == "true")
                {
                    redirectToLogin();
                }
                else{
                    hideLoading();
                    $('#dvDealSynMaterialList').html(result);
                    showAlert('S', '@objMessageKey.Materialdeletedsuccessfully');
                    initializeTooltip();
                }
            },
            error: function (result) {
                alert('Error: ' + result.responseText);
            }
        });

    }

    function handleCancel() {
        return false;
    }

    function ValidateSave() {
        showLoading();
        var Isvalid = true;
        var Mode = '@ViewBag.PageMode';
        if (Mode == dealMode_View || Mode == 'APRV') {
            hideLoading();
            var tabName = $('#hdnTabName').val();
            BindPartialTabs(tabName);
        }
        else {
            if (CheckEditMode()) {
                showLoading();
                $("#hdnMaterialRemark").val($("#txtMaterialRemarks").val());
                var Isvalid = true;
                // Code for Maintaining approval remarks in session
                var Mode = '@ViewBag.PageMode';
                if (Mode == 'APRV') {
                    var approvalremarks = $('#approvalremarks').val();
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("SetSynApprovalRemarks", "Global")',
                        traditional: true,
                        enctype: 'multipart/form-data',
                        contentType: "application/json; charset=utf-8",
                        async: true,
                        data: JSON.stringify({
                            approvalremarks: $('#approvalremarks').val()
                        }),
                        success: function (result) {
                            if (result == "true") {
                                redirectToLogin();
                            }
                            else {
                                Isvalid = true;
                            }
                        },
                        error: function (result) {
                            Isvalid = false;
                        }
                    });
                }
                else
                    Isvalid = true;
                if (Isvalid) {
                    hideLoading();
                    var tabName = $('#hdnTabName').val();
                    BindPartialTabs(tabName);
                }
                hideLoading();
                return Isvalid;
            }
        }
    }

    /*On Add or Cancel Click*/
    function AddCancelMaterial(isAdd) {
        debugger;
        if ($("#txtPageSize").val() == "") {
            return false;
        }
        var txtPageSize = $("#txtPageSize").val();
        var pageNo = $('#hdnpage_index').val();
        if (isAdd == "0" || (CheckEditMode() && isAdd == "1")) {
            showLoading();
            if(isAdd == "0")
                IsAddEditMode="N";
            else
                IsAddEditMode="Y";
            $.ajax({
                type: "POST",
                url: '@Url.Action("Create", "Syn_Material")',
                traditional: true,
                enctype: 'multipart/form-data',
                contentType: "application/json; charset=utf-8",
                dataType: "html",
                data: JSON.stringify({
                    isAdd: isAdd,
                    txtPageSize: txtPageSize,
                    pageNo: pageNo
                }),
                success: function (result) {
                    if (result == "true")
                    {
                        redirectToLogin();
                    }
                    else{
                        $('#dvDealSynMaterialList').empty();
                        $('#dvDealSynMaterialList').html(result);
                        initializeChosen();
                        initializeTooltip();
                        hideLoading();
                    }
                },
                error: function (result) {
                    alert('Error: ' + result.responseText);
                }
            });
        }
    }

    /*Edit Material*/
    function EditMaterial(Syn_Deal_Material_Code) {
        var txtPageSize = $("#txtPageSize").val();
        var pageNo = $('#hdnpage_index').val();
        if (CheckEditMode()) {
            IsAddEditMode="Y";
            $.ajax({
                type: "POST",
                url: '@Url.Action("Edit", "Syn_Material")',
                traditional: true,
                enctype: 'multipart/form-data',
                contentType: "application/json; charset=utf-8",
                dataType: "html",
                data: JSON.stringify({
                    Syn_Deal_Material_Code: Syn_Deal_Material_Code,
                    txtPageSize: txtPageSize,
                    pageNo: pageNo
                }),
                success: function (result) {
                    if (result == "true")
                    {
                        redirectToLogin();
                    }
                    else{
                        $('#dvDealSynMaterialList').html(result);
                        initializeChosen();
                        initializeTooltip();
                    }
                },
                error: function (result) {
                    alert('Error: ' + result.responseText);
                }
            });
        }
    }

    function CancelSaveDeal() {
        $('#hdn_Command_Name').val('CANCEL_SAVE_DEAL');
        showAlert("I", '@objMessageKey.AllUnsavedDataWillBeLostStillWantToGoAhead', "OKCANCEL");
    }

    function OnFinalSaveClick() {
        var Isvalid = true;

        if (!clickedOnTab) {
            if ($(event.target).val().toUpperCase() == "SAVE & APPROVE") {
                $('input[name=hdnReopenMode]').val('RO');
            }
            else {
                $('input[name=hdnReopenMode]').val('E');
            }
        }
        else {
            $('input[name=hdnReopenMode]').val('E');
        }

        if (CheckEditMode()) {
            $("#hdnMaterialRemark").val($("#txtMaterialRemarks").val());
        }
        else {
            Isvalid = false;
        }
        return Isvalid;
    }

    function ClearHidden() {
        $("#hdnTabName").val('');
    }

    function Save_Success(message) {
        debugger;
        hideLoading();
        if (message == "true") {
            redirectToLogin();
        }
        else {
            if (message.Status == "SA") {
                debugger;
                $.ajax({
                    type: "POST",
                    url: URL_Syn_Approve_Reject,
                    traditional: true,
                    enctype: 'multipart/form-data',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({
                        user_Action: 'A',
                        approvalremarks: ""
                    }),
                    async: false,
                    success: function (data) {
                    }
                });
            }
            if (message.Success_Message != "") {
                MessageFrom = "SV"
                showAlert('S', message.Success_Message, 'OK');
            }
            else {
                var tabName = $('#hdnTabName').val();
                BindPartialTabs(tabName);
            }
        }
    }

</script>
<style>
    span::after {
        content: "\200E‎";
    }

    label::after {
        content: "\200E‎";
    }

    .active-result::after {
        content: "\200E‎";
    }
</style>
<script>
    $('.expand_MaterialRemarks').expander({
        slicePoint: 520,
        expandPrefix: '',
        expandText: '@objMessageKey.readmore',
        collapseTimer: 0,
        userCollapseText: '<span>[^]</span>'
    });
</script>

@using (Ajax.BeginForm("ChangeTab", "Syn_Material", new AjaxOptions { OnSuccess = "Save_Success" }))
{    
    <input type="hidden" id="hdnTabName" name="hdnTabName" />
    @Html.Hidden("hdnMaterialRemark")
    @Html.Hidden("hdn_Command_Name")
    <div class="grid_area">
        <div class="navigation_tabs">
            <div class="tabbable">
                <div class="tab-content clearfix table-wrapper scale_table_container syn">
                    <div class="tab-pane active" id="tabPayTerm">
                        <div class="scale_table_block">
                            <div class="sub_block clearfix">
                                <div class="pull-right">
                                    @if (ViewBag.PageMode != "V" && ViewBag.PageMode != "APRV")
                                    {
                                        <a class="btn btn-primary" title="@objMessageKey.AddMaterial" onclick="return AddCancelMaterial(1);">@objMessageKey.Add</a>
                                    }
                                </div>
                            </div>
                            <div class="paging_area clearfix">
                                <span id="spanRecordCount" class="pull-left">@objMessageKey.TotalRecords:  @ViewBag.RecordCount</span>
                                <input type="hidden" id="hdnpage_index" name="hdnpage_index" value="1" />
                                <div class="pagination" id="Pagination"></div>
                                <span class="pull-right">
                                    @objMessageKey.PageSize:
                                    <input type="text" class="smallTextBox pagingSize" value="10" id="txtPageSize" onchange="return PageSize_OnChange();" onfocus="CheckEditMode()"
                                           onblur="setDefaultPaging('txtPageSize')" />
                                </span>
                            </div>
                            <div class="scale_table_block" id="dvDealSynMaterialList">
                            </div>
                            <br>
                            <div>
                                <span class="remarks">@objMessageKey.Remarks:</span>
                                @if (ViewBag.PageMode != "V" && ViewBag.PageMode != "APRV")
                                {
                                    <textarea name="txtMaterialRemarks" id="txtMaterialRemarks" style="margin-left:0px;" class="textarea" onkeypress="countChar(this)" onkeyup="countChar(this)">@ViewBag.Remark</textarea>
                                    <div class="divBlock">
                                        <div id="CharNum" class="charNum">4000</div>
                                    </div>
                                }
                                else
                                {
                                    <br />
                                    <div class="expand_MaterialRemarks" style="margin-left:0px;">

                                        @if (ViewBag.Remark != null)
                                        {
                                            @Html.Raw(ViewBag.Remark.Replace("\r\n", "<br/>").Replace("\n", "<br/>"))
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                    @if (ViewBag.PageMode == "APRV")
                    {
                        @Html.Partial("_Syn_Approved_List")
                        <br />
                    }
                    else
                    {

                        <div class="bottom_action">

                            @Html.Hidden("HdnRemark")
                            <ul class="form_link_nav clearfix">
                                @if (ViewBag.PageMode != "V" && ViewBag.PageMode != "APRV")
                                {
                                    <li>
                                        <input type="submit" id="btnSaveDeal" title="@objMessageKey.Save" value="@objMessageKey.Save" class="btn btn-primary save" onclick="return OnFinalSaveClick();" />
                                        <input type="hidden" id="hdnReopenMode" name="hdnReopenMode" value="E" />
                                        @*<input type="submit" value="Save" class="btn btn-primary"  />*@

                                    </li>
                                    if (objSchema.Deal_Workflow_Flag.ToUpper() == GlobalParams.DEAL_MODE_REOPEN)
                                    {
                                        <li>
                                            <input type="submit" id="btnSaveApproveDeal" class="btn btn-primary saveapprove" value="Save & Approve" onclick="ClearHidden(); return OnFinalSaveClick();">
                                        </li>
                                    }
                                    <li>
                                        <input type="button" id="btnCancelDeal" title="@objMessageKey.Cancel" class="btn btn-primary" value="@objMessageKey.Cancel"
                                               onclick="if(CheckEditMode()) CancelSaveDeal()">
                                    </li>
                                }
                                else
                                {
                                    <li>
                                        <input type="button" id="btnCancel_Deal" title="@objMessageKey.Cancel" class="btn btn-primary" value="@objMessageKey.Cancel"
                                               onclick="if(CheckEditMode()) location.href='@Url.Action("Cancel", "Syn_Material")    '">
                                    </li>
                                }
                            </ul>

                        </div>
                    }
                    
                </div>
            </div>
        </div>
    </div>
}
